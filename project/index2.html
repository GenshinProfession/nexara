<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件分片上传测试</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .upload-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px dashed #3498db;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section:hover {
            background-color: #f0f8ff;
            border-color: #2980b9;
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 15px 30px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        .file-label:hover {
            background: #2980b9;
        }

        .selected-file {
            margin-top: 15px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-item {
            margin-bottom: 15px;
        }

        .config-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .config-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .init-btn {
            background: #2ecc71;
            color: white;
        }

        .init-btn:hover {
            background: #27ae60;
        }

        .upload-btn {
            background: #3498db;
            color: white;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .status-btn {
            background: #f39c12;
            color: white;
        }

        .status-btn:hover {
            background: #e67e22;
        }

        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .progress-section {
            margin-bottom: 30px;
        }

        .progress-bar {
            height: 25px;
            background: #ecf0f1;
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #2ecc71;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #7f8c8d;
        }

        .status-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .status-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .status-content {
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .log-time {
            color: #95a5a6;
            margin-right: 10px;
        }

        .log-message {
            color: #34495e;
        }

        .success {
            color: #27ae60;
        }

        .error {
            color: #e74c3c;
        }

        .info {
            color: #3498db;
        }

        @media (max-width: 768px) {
            .config-section {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>文件分片上传测试</h1>

    <div class="upload-section">
        <input type="file" id="fileInput" class="file-input">
        <label for="fileInput" class="file-label">选择文件</label>
        <div id="selectedFile" class="selected-file">未选择文件</div>
    </div>

    <div class="config-section">
        <div class="config-item">
            <label for="chunkSize">分片大小 (KB)</label>
            <input type="number" id="chunkSize" value="1024" min="1024">
        </div>
        <div class="config-item">
            <label for="batchSize">批次上传数量</label>
            <input type="number" id="batchSize" value="5" min="1" max="20">
        </div>
        <div class="config-item">
            <label for="maxRetries">最大重试次数</label>
            <input type="number" id="maxRetries" value="3" min="1" max="10">
        </div>
    </div>

    <div class="button-group">
        <button id="initBtn" class="init-btn" disabled>初始化上传</button>
        <button id="uploadBtn" class="upload-btn" disabled>开始上传</button>
        <button id="pauseBtn" class="status-btn" disabled>暂停上传</button>
        <button id="resumeBtn" class="status-btn" disabled>继续上传</button>
        <button id="statusBtn" class="status-btn">查询状态</button>
    </div>

    <div class="progress-section">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill">0%</div>
        </div>
        <div class="progress-info">
            <span id="progressText">等待上传...</span>
            <span id="chunkInfo">分片: 0/0</span>
        </div>
    </div>

    <div class="status-section">
        <div class="status-title">上传状态信息</div>
        <div id="statusContent" class="status-content">
            <div class="log-entry">
                <span class="log-time">[系统]</span>
                <span class="log-message">准备就绪，请选择文件</span>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局变量
    let selectedFile = null;
    let fileHash = '';
    let totalChunks = 0;
    let uploadedChunks = 0;
    let uploadTask = null;
    let isUploading = false;
    let isPaused = false;
    let retryCount = 0;

    // DOM元素
    const fileInput = document.getElementById('fileInput');
    const selectedFileDiv = document.getElementById('selectedFile');
    const chunkSizeInput = document.getElementById('chunkSize');
    const batchSizeInput = document.getElementById('batchSize');
    const maxRetriesInput = document.getElementById('maxRetries');
    const initBtn = document.getElementById('initBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const statusBtn = document.getElementById('statusBtn');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const chunkInfo = document.getElementById('chunkInfo');
    const statusContent = document.getElementById('statusContent');

    // 事件监听
    fileInput.addEventListener('change', handleFileSelect);
    initBtn.addEventListener('click', initUpload);
    uploadBtn.addEventListener('click', startUpload);
    pauseBtn.addEventListener('click', pauseUpload);
    resumeBtn.addEventListener('click', resumeUpload);
    statusBtn.addEventListener('click', checkStatus);

    // 选择文件处理
    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        selectedFile = file;
        selectedFileDiv.textContent = `已选择: ${file.name} (${formatFileSize(file.size)})`;
        addLog('文件已选择，准备计算文件Hash...', 'info');

        // 计算文件Hash
        calculateFileHash(file)
            .then(hash => {
                fileHash = hash;
                totalChunks = Math.ceil(file.size / (chunkSizeInput.value * 1024));
                addLog(`文件Hash计算完成: ${hash}`, 'success');
                addLog(`文件将分为 ${totalChunks} 个分片上传`, 'info');
                initBtn.disabled = false;
            })
            .catch(error => {
                addLog(`Hash计算失败: ${error.message}`, 'error');
            });
    }

    // 计算文件SHA-256 Hash
    async function calculateFileHash(file) {
        addLog('正在计算文件Hash...', 'info');

        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const buffer = e.target.result;
                    const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    resolve(hashHex);
                } catch (error) {
                    reject(error);
                }
            };
            reader.onerror = () => reject(new Error('文件读取失败'));
            reader.readAsArrayBuffer(file);
        });
    }

    // 初始化上传
    async function initUpload() {
        if (!selectedFile || !fileHash) {
            addLog('请先选择文件', 'error');
            return;
        }

        try {
            addLog('正在初始化上传任务...', 'info');

            const response = await fetch('http://localhost:8080/server/upload/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fileHash,
                    fileName: selectedFile.name,
                    totalChunks,
                    chunkSize: chunkSizeInput.value * 1024
                })
            });

            const result = await response.json();

            if (response.ok && result.code === 200) {
                addLog('上传任务初始化成功', 'success');
                uploadBtn.disabled = false;
                pauseBtn.disabled = false;
                progressText.textContent = '准备上传';
                chunkInfo.textContent = `分片: 0/${totalChunks}`;
            } else {
                addLog(`初始化失败: ${result.msg || '未知错误'}`, 'error');
            }
        } catch (error) {
            addLog(`初始化请求失败: ${error.message}`, 'error');
        }
    }

    // 开始上传
    async function startUpload() {
        if (!selectedFile || !fileHash) {
            addLog('请先选择文件并初始化', 'error');
            return;
        }

        isUploading = true;
        isPaused = false;
        uploadBtn.disabled = true;
        initBtn.disabled = true;
        pauseBtn.disabled = false;
        resumeBtn.disabled = true;
        retryCount = 0;

        addLog('开始分片上传...', 'info');
        await uploadWithRetry();
    }

    // 带重试机制的上传
    async function uploadWithRetry() {
        const maxRetries = parseInt(maxRetriesInput.value);
        const batchSize = parseInt(batchSizeInput.value);

        while (isUploading && !isPaused) {
            try {
                // 获取当前上传状态
                const statusResponse = await fetch(`http://localhost:8080/server/upload/status?fileHash=${fileHash}`);
                const statusResult = await statusResponse.json();

                if (!statusResponse.ok) {
                    throw new Error('获取状态失败');
                }

                const task = statusResult.data;
                const finalChunks = task.uploadProgress.finalChunks || 0;
                const uploadedSet = new Set(task.uploadProgress.uploadedChunks || []);

                addLog(`当前连续分片: ${finalChunks}, 已上传分片数: ${uploadedSet.size}`, 'info');

                // 计算需要上传的分片范围
                let startChunk;
                if (finalChunks === 0) {
                    startChunk = 0;
                } else {
                    startChunk = finalChunks + 1;
                }
                let endChunk = Math.min(startChunk + batchSize - 1, totalChunks - 1);

                // 过滤掉已经上传的分片
                const chunksToUpload = [];
                for (let i = startChunk; i <= endChunk; i++) {
                    if (!uploadedSet.has(i)) {
                        chunksToUpload.push(i);
                    }
                }

                if (chunksToUpload.length === 0) {
                    // 所有分片都已上传，检查是否完成
                    if (uploadedSet.size === totalChunks) {
                        addLog('所有分片上传完成!', 'success');
                        isUploading = false;
                        break;
                    } else {
                        // 有分片丢失，需要重新检查
                        addLog('检测到分片丢失，重新检查状态...', 'warning');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        continue;
                    }
                }

                // 准备当前批次的分片
                const formData = new FormData();
                formData.append('fileHash', fileHash);

                const chunkSize = chunkSizeInput.value * 1024;
                for (const chunkIndex of chunksToUpload) {
                    const start = chunkIndex * chunkSize;
                    const end = Math.min(start + chunkSize, selectedFile.size);
                    const chunk = selectedFile.slice(start, end);
                    const blob = new Blob([chunk], { type: 'application/octet-stream' });
                    formData.append('chunks', blob, `${chunkIndex}.part`);
                }

                // 上传当前批次
                addLog(`上传分片: ${chunksToUpload.join(', ')}`, 'info');
                const response = await fetch('http://localhost:8080/server/upload/chunk-batch', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.code === 200) {
                    retryCount = 0; // 重置重试计数
                    uploadedChunks += chunksToUpload.length;

                    // 更新进度
                    const progress = Math.round((uploadedSet.size + chunksToUpload.length) / totalChunks * 100);
                    progressFill.style.width = `${progress}%`;
                    progressFill.textContent = `${progress}%`;
                    progressText.textContent = `上传中... ${progress}%`;
                    chunkInfo.textContent = `分片: ${uploadedSet.size + chunksToUpload.length}/${totalChunks}`;

                    addLog(`批次上传成功`, 'success');
                } else {
                    throw new Error(result.msg || '上传失败');
                }

            } catch (error) {
                retryCount++;
                addLog(`上传失败 (${retryCount}/${maxRetries}): ${error.message}`, 'error');

                if (retryCount >= maxRetries) {
                    addLog('达到最大重试次数，上传终止', 'error');
                    isUploading = false;
                    uploadBtn.disabled = false;
                    break;
                }

                // 等待一段时间后重试
                await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
            }
        }

        if (!isUploading) {
            uploadBtn.disabled = false;
            pauseBtn.disabled = true;
            resumeBtn.disabled = true;
        }
    }

    // 暂停上传
    function pauseUpload() {
        isPaused = true;
        pauseBtn.disabled = true;
        resumeBtn.disabled = false;
        addLog('上传已暂停', 'info');
    }

    // 继续上传
    function resumeUpload() {
        isPaused = false;
        pauseBtn.disabled = false;
        resumeBtn.disabled = true;
        addLog('继续上传...', 'info');
        uploadWithRetry();
    }

    // 检查上传状态
    async function checkStatus() {
        if (!fileHash) {
            addLog('请先选择文件', 'error');
            return;
        }

        try {
            addLog('正在查询上传状态...', 'info');

            const response = await fetch(`http://localhost:8080/server/upload/status?fileHash=${fileHash}`);
            const result = await response.json();

            if (response.ok && result.code === 200) {
                const task = result.data;
                const uploadedSet = new Set(task.uploadProgress.uploadedChunks || []);

                addLog(`上传状态: ${task.uploadProgress.status}`, 'info');
                addLog(`进度: ${task.uploadProgress.progress}%`, 'info');
                addLog(`连续分片: ${task.uploadProgress.finalChunks || 0}`, 'info');
                addLog(`已上传分片: ${uploadedSet.size}/${task.totalChunks}`, 'info');

                // 显示丢失的分片
                const missingChunks = [];
                for (let i = 0; i < task.totalChunks; i++) {
                    if (!uploadedSet.has(i)) {
                        missingChunks.push(i);
                    }
                }

                if (missingChunks.length > 0) {
                    addLog(`丢失分片: ${missingChunks.join(', ')}`, 'warning');
                }
            } else {
                addLog(`状态查询失败: ${result.msg || '未知错误'}`, 'error');
            }
        } catch (error) {
            addLog(`状态查询请求失败: ${error.message}`, 'error');
        }
    }

    // 添加日志
    function addLog(message, type = 'info') {
        const now = new Date();
        const timeString = now.toTimeString().split(' ')[0];

        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-time">[${timeString}]</span>
            <span class="log-message ${type}">${message}</span>
        `;

        statusContent.appendChild(logEntry);
        statusContent.scrollTop = statusContent.scrollHeight;
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
        else return (bytes / 1048576).toFixed(2) + ' MB';
    }
</script>
</body>
</html>